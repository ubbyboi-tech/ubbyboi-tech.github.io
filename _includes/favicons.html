<!-- Favicons -->
<link
  rel="apple-touch-icon"
  sizes="180x180"
  href="{{ '/assets/img/favicons/favicon-512x512.png' | relative_url }}"
/>
<link
  rel="icon"
  type="image/png"
  sizes="32x32"
  href="{{ '/assets/img/favicons/favicon-32x32.png' | relative_url }}"
/>
<link
  rel="icon"
  type="image/png"
  sizes="16x16"
  href="{{ '/assets/img/favicons/favicon-16x16.png' | relative_url }}"
/>
<link
  rel="shortcut icon"
  href="{{ '/assets/img/favicons/favicon.ico' | relative_url }}"
/>
<link rel="icon" href="{{ '/favicon.ico' | relative_url }}" />

<!-- GLightbox Initialization and Fix -->
<script>
  (function () {
    let glightboxInstance = null;

    function initGLightbox() {
      // Check if GLightbox library is available
      if (typeof GLightbox === "undefined") {
        // Try again after a delay
        setTimeout(initGLightbox, 100);
        return;
      }

      // Prevent default link behavior for .glightbox links
      document.addEventListener(
        "click",
        function (e) {
          const link = e.target.closest("a.glightbox");
          if (link) {
            e.preventDefault();
            e.stopPropagation();

            // Initialize GLightbox if not already done
            if (!glightboxInstance) {
              glightboxInstance = GLightbox({
                selector: ".glightbox",
                closeButton: true,
                closeOnOutsideClick: true,
                touchNavigation: true,
                keyboardNavigation: true,
                openEffect: "fade",
                closeEffect: "fade",
              });
              window.glightboxInstance = glightboxInstance;
            }

            // Open the clicked image
            const href = link.getAttribute("href");
            if (href) {
              glightboxInstance.open(href);
            }
            return false;
          }
        },
        true
      ); // Use capture phase

      // Initialize GLightbox for all .glightbox links
      if (!glightboxInstance) {
        glightboxInstance = GLightbox({
          selector: ".glightbox",
          closeButton: true,
          closeOnOutsideClick: true,
          touchNavigation: true,
          keyboardNavigation: true,
          openEffect: "fade",
          closeEffect: "fade",
        });
        window.glightboxInstance = glightboxInstance;
      }

      // Fix close functionality
      fixGLightboxClose();
    }

    function fixGLightboxClose() {
      // Close on backdrop click
      document.addEventListener(
        "click",
        function (e) {
          const container = document.querySelector(".glightbox-container");
          if (!container) return;

          const isVisible =
            container.offsetParent !== null &&
            !container.classList.contains("glightbox-hide") &&
            window.getComputedStyle(container).display !== "none";

          if (!isVisible) return;

          // Close on backdrop click
          if (
            e.target === container ||
            (e.target.classList.contains("glightbox-container") &&
              !e.target.closest(".gslide") &&
              !e.target.closest(".gslide-media"))
          ) {
            e.preventDefault();
            e.stopPropagation();
            if (
              glightboxInstance &&
              typeof glightboxInstance.close === "function"
            ) {
              glightboxInstance.close();
            }
            return false;
          }

          // Close button click
          if (
            e.target.classList.contains("gbtn-close") ||
            e.target.closest(".gbtn-close") ||
            e.target.classList.contains("glightbox-close") ||
            e.target.closest(".glightbox-close")
          ) {
            e.preventDefault();
            e.stopPropagation();
            if (
              glightboxInstance &&
              typeof glightboxInstance.close === "function"
            ) {
              glightboxInstance.close();
            }
            return false;
          }
        },
        true
      );

      // ESC key handler
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape" || e.keyCode === 27) {
          const container = document.querySelector(".glightbox-container");
          if (container && container.offsetParent !== null) {
            if (
              glightboxInstance &&
              typeof glightboxInstance.close === "function"
            ) {
              glightboxInstance.close();
            }
          }
        }
      });
    }

    // Initialize when DOM is ready
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initGLightbox);
    } else {
      initGLightbox();
    }

    // Also try after page load
    window.addEventListener("load", function () {
      setTimeout(initGLightbox, 100);
      setTimeout(initGLightbox, 500);
    });
  })();
</script>
